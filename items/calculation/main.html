<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>GfEditer - V013 (Size Fixed)</title>

	<script src="../../libs/Three.js"></script>
	<script src="../../libs/raphael-min.2.0.1.js"></script>
	<script src="../../libs/kekule/kekule.js?modules=calculation,chemWidget,openbabel"></script>
	<link rel="stylesheet" type="text/css" href="../../libs/kekule/themes/default/kekule.css" />
	
	<style>
		:root {
			--app-bg: #f8f9fa;
			--app-header: #ffffff;
			--app-border: #e0e2e6;
			--accent-blue: #1a73e8;
			--accent-orange: #f29900;
		}

		body, html {
			margin: 0; padding: 0; height: 100vh; width: 100vw;
			font-family: 'Inter', sans-serif; overflow: hidden;
		}

		body { display: flex; flex-direction: column; }

		header {
			height: 60px; flex-shrink: 0; background: var(--app-header);
			border-bottom: 1px solid var(--app-border);
			display: flex; justify-content: space-between; align-items: center;
			padding: 0 24px; z-index: 100;
		}

		.app-container {
			flex: 1; overflow-y: auto; overflow-x: hidden;
			scroll-behavior: smooth; display: flex; flex-direction: column;
		}

		/* メインセクションの高さを 85vh に固定し、崩れを防ぐ */
		.view-section {
			display: flex; width: 100%; height: 85vh; min-height: 500px;
			flex-shrink: 0; position: relative; border-bottom: 2px solid var(--app-border);
		}

		.editor-section {
			display: flex; width: 100%; height: 600px;
			flex-shrink: 0; background: #fff;
		}

		.tool-column { height: 100%; display: flex; flex-direction: column; overflow: hidden; }
		.col-left { flex: 0 0 50%; }
		.col-right { flex: 1; }

		/* ウィジェット自体の強制拡大 */
		.K-ChemWidget { width: 100% !important; height: 100% !important; }

		#global-resizer {
			width: 10px; cursor: col-resize; position: absolute; left: 50%; top: 0; bottom: 0;
			z-index: 1000; transform: translateX(-50%); background: transparent;
		}
		#global-resizer::after { content: ""; position: absolute; left: 4px; top: 0; bottom: 0; width: 2px; background: var(--app-border); }

		.header-btn { padding: 8px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid transparent; }
		#ext-btn-gen { background: var(--accent-blue); color: white; }
		#ext-btn-goto { background: #3c4043; color: white; margin-left: 8px; }

		#gamess-editor { width: 100%; height: 100%; border: none; padding: 20px; font-family: monospace; background: #1e1e1e; color: #d4d4d4; resize: none; }
		.editor-footer { padding: 10px 20px; background: #2d2d2d; display: flex; justify-content: flex-end; }
		#ext-btn-download { background: var(--accent-orange); color: white; padding: 8px 20px; border: none; cursor: pointer; border-radius: 4px; }
	</style>
</head>

<body>
	<header>
		<div style="display:flex; align-items:center;">
			<div style="font-size:20px; font-weight:700;"><span style="color:var(--accent-blue)">G</span>fEditer</div>
			<div id="state" style="font-size:12px; margin-left:15px; background:#e8f0fe; padding:5px 15px; border-radius:20px;">Ready</div>
		</div>
		<div>
			<button id="ext-btn-gen" class="header-btn" onclick="generate3D()">Generate 3D</button>
			<button id="ext-btn-goto" class="header-btn" onclick="scrollToEditor()">Go to GAMESS Editor ↓</button>
		</div>
	</header>

	<div class="app-container" id="scroll-container">
		<div class="view-section" id="top-section">
			<div id="section-left-top" class="tool-column col-left">
				<!-- data-auto-size="true" に設定し、コンテナに合わせる -->
				<div id="composer" data-widget="Kekule.Editor.Composer" data-predefined-setting="molOnly" data-auto-size="true"></div>
			</div>
			<div id="global-resizer"></div>
			<div id="section-right-top" class="tool-column col-right">
				<div id="chemViewer" data-widget="Kekule.ChemWidget.Viewer3D" data-predefined-setting="fullFunc" data-auto-size="true"></div>
			</div>
		</div>

		<div class="editor-section" id="gamess-section">
			<div class="tool-column col-left" style="padding:40px; box-sizing:border-box; background:#fdfdfd; border-right:1px solid #eee;">
				<h2 style="margin:0 0 20px 0; font-size:18px;">GAMESS Settings</h2>
				<select id="cfg-scf" onchange="updateGamessText()" style="width:100%; padding:10px; margin-bottom:15px;"><option value="RHF">RHF</option><option value="UHF">UHF</option></select>
				<select id="cfg-run" onchange="updateGamessText()" style="width:100%; padding:10px; margin-bottom:15px;"><option value="OPTIMIZE">OPTIMIZE</option><option value="ENERGY">ENERGY</option></select>
				<select id="cfg-basis" onchange="updateGamessText()" style="width:100%; padding:10px;"><option value="N31">6-31G</option><option value="STO">STO-3G</option></select>
			</div>
			<div class="tool-column col-right">
				<textarea id="gamess-editor" spellcheck="false"></textarea>
				<div class="editor-footer"><button id="ext-btn-download" onclick="downloadInp()">Download .inp</button></div>
			</div>
		</div>
	</div>

	<script>
	var composer, viewer, calculator;

	function scrollToEditor() { document.getElementById('gamess-section').scrollIntoView({ behavior: 'smooth' }); }
	
	function syncSizes() {
		// ウィジェットに対して明示的に再描画とサイズ更新を命令する
		if (composer) {
			composer.setDimension('100%', '100%');
			composer.notifyObjectSizeChanged();
		}
		if (viewer) {
			viewer.setDimension('100%', '100%');
			viewer.notifyObjectSizeChanged();
		}
	}

	function generate3D() {
		var mol = Kekule.ChemStructureUtils.getTotalStructFragment(composer.getChemObj());
		if (!mol || mol.getNodeCount() === 0) return;
		document.getElementById('state').innerHTML = 'Calculating...';
		
		calculator = Kekule.Calculator.generate3D(mol, {'forceField': 'MMFF94'},
			function(generatedMol){
				viewer.setChemObj(generatedMol);
				updateGamessText();
				document.getElementById('state').innerHTML = 'Ready';
				syncSizes();
			}
		);
	}

	function updateGamessText() {
		var mol = viewer.getChemObj();
		if (!mol) return;
		var lines = [` $CONTRL SCFTYP=${document.getElementById('cfg-scf').value} RUNTYP=${document.getElementById('cfg-run').value} COORD=UNIQUE $END`, ` $BASIS GBASIS=${document.getElementById('cfg-basis').value} $END`, ' $DATA\nGAMESS Input\nC1'];
		for (var i = 0; i < mol.getNodeCount(); ++i) {
			var node = mol.getNodeAt(i);
			if (node instanceof Kekule.Atom) {
				var coord = node.getAbsCoord3D() || node.getCoord3D();
				lines.push(` ${node.getSymbol().padEnd(5)} ${node.getAtomicNumber().toString().padStart(5)}.0 ${coord.x.toFixed(8).padStart(14)} ${coord.y.toFixed(8).padStart(14)} ${coord.z.toFixed(8).padStart(14)}`);
			}
		}
		lines.push(' $END');
		document.getElementById('gamess-editor').value = lines.join('\n');
	}

	function init() {
		viewer = Kekule.Widget.getWidgetById('chemViewer');
		composer = Kekule.Widget.getWidgetById('composer');

		// リサイズ連動ロジック
		const resizer = document.getElementById('global-resizer');
		const leftCols = document.querySelectorAll('.col-left');
		let isResizing = false;

		resizer.addEventListener('mousedown', (e) => { isResizing = true; e.preventDefault(); });
		window.addEventListener('mousemove', (e) => {
			if (!isResizing) return;
			const newWidth = (e.clientX / window.innerWidth) * 100;
			if (newWidth > 10 && newWidth < 90) {
				leftCols.forEach(el => el.style.flex = `0 0 ${newWidth}%`);
				resizer.style.left = newWidth + '%';
				syncSizes();
			}
		});
		window.addEventListener('mouseup', () => { isResizing = false; });

		// ページロード完了後、少し遅延させてサイズを確定させる（最重要）
		window.addEventListener('load', () => {
			setTimeout(syncSizes, 100);
			setTimeout(syncSizes, 600); // 念のための2回実行
		});
		window.addEventListener('resize', syncSizes);
	}

	function downloadInp() {
		var blob = new Blob([document.getElementById('gamess-editor').value], { type: 'text/plain' });
		var a = document.createElement('a');
		a.href = URL.createObjectURL(blob);
		a.download = 'gamess.inp';
		a.click();
	}

	Kekule.X.domReady(init);
	</script>
</body>
</html>
