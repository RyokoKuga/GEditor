<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>3D Molecular Studio Pro</title>

	<script src="../../libs/Three.js"></script>
	<script src="../../libs/raphael-min.2.0.1.js"></script>
	<script src="../../libs/kekule/kekule.js?modules=calculation,chemWidget,openbabel"></script>
	<link rel="stylesheet" type="text/css" href="../../libs/kekule/themes/default/kekule.css" />
	
	<style>
		:root {
			--app-bg: #f8f9fa;
			--app-header: #ffffff;
			--app-border: #e0e2e6;
			--app-text-main: #202124;
			--app-text-sub: #5f6368;
			--accent-blue: #1a73e8;
			--accent-red: #d93025;
			--status-bg: #e8f0fe;
			--status-text: #174ea6;
			--shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
		}

		body {
			background-color: var(--app-bg);
			color: var(--app-text-main);
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			margin: 0;
			display: flex;
			flex-direction: column;
			height: 100vh;
			overflow: hidden;
		}

		/* 洗練されたヘッダーデザイン */
		header {
			background: var(--app-header);
			padding: 0 24px;
			border-bottom: 1px solid var(--app-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			height: 56px;
			box-shadow: 0 1px 2px rgba(0,0,0,0.05);
			z-index: 100;
		}

		.header-left { display: flex; align-items: center; gap: 20px; }
		.logo { font-size: 18px; font-weight: 600; letter-spacing: -0.5px; color: var(--app-text-main); }

		/* ステータスバッジの改善 */
		#state {
			font-size: 12px;
			color: var(--status-text);
			background: var(--status-bg);
			padding: 5px 14px;
			border-radius: 20px;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 6px;
		}
		#state::before {
			content: "";
			width: 6px;
			height: 6px;
			background: var(--accent-blue);
			border-radius: 50%;
			display: inline-block;
		}

		/* 独立したTerminateボタンの洗練 */
		#ext-btn-terminate {
			background-color: transparent;
			color: var(--accent-red);
			border: 1px solid #fad2cf;
			padding: 6px 16px;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		}
		#ext-btn-terminate:hover:not(:disabled) {
			background-color: #fef1f0;
			border-color: var(--accent-red);
			box-shadow: 0 1px 2px rgba(217, 48, 37, 0.1);
		}
		#ext-btn-terminate:disabled {
			color: #bdc1c6;
			border-color: var(--app-border);
			cursor: default;
		}

		.app-container {
			flex: 1;
			display: flex;
			flex-direction: row;
			padding: 12px;
			gap: 0; /* リサイザがあるため0 */
			min-height: 0;
		}

		.tool-section {
			display: flex;
			flex-direction: column;
			background: var(--white);
			border: 1px solid var(--app-border);
			border-radius: 8px;
			overflow: hidden;
			background: #fff;
			box-shadow: 0 1px 3px rgba(0,0,0,0.05);
		}

		#section-left { flex: 0 0 50%; }
		#section-right { flex: 1; }

		/* リサイザをよりスマートに */
		#resizer {
			width: 12px;
			cursor: col-resize;
			background: transparent;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
		}
		#resizer::after {
			content: "";
			width: 2px;
			height: 30px;
			background: var(--app-border);
			border-radius: 2px;
		}
		#resizer:hover::after { background: var(--accent-blue); width: 4px; }

		#composer, #chemViewer {
			width: 100% !important;
			height: 100% !important;
		}

		/* 3Dツールバーのフロートスタイル */
		.K-ChemWidget-Toolbar {
			opacity: 1 !important;
			background: rgba(255, 255, 255, 0.92) !important;
			border: 1px solid var(--app-border) !important;
			border-radius: 8px !important;
			margin: 10px !important;
			box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
		}

		footer {
			background: var(--app-header);
			padding: 0 24px;
			font-size: 11px;
			color: var(--app-text-sub);
			border-top: 1px solid var(--app-border);
			height: 32px;
			display: flex;
			align-items: center;
		}
	</style>

	<script id="molSrc" type="chemical/x-kekule-json">
	{"id":"m1","ctab":{"nodes":[{"__type":"Kekule.Atom","id":"a4","coord2D":{"x":0.7958,"y":0.4315},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a11","coord2D":{"x":0.0117,"y":0.1764},"charge":0,"isotopeId":"N"},{"__type":"Kekule.Atom","id":"a5","coord2D":{"x":0.7958,"y":1.2565},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a3","coord2D":{"x":1.5115,"y":0.0175},"charge":0,"isotopeId":"N"},{"__type":"Kekule.Atom","id":"a14","coord2D":{"x":0.0117,"y":-1.4648},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a7","coord2D":{"x":-0.4738,"y":0.8439},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a6","coord2D":{"x":1.5115,"y":1.6689},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a8","coord2D":{"x":0.0117,"y":1.5115},"charge":0,"isotopeId":"N"},{"__type":"Kekule.Atom","id":"a2","coord2D":{"x":2.2257,"y":0.4315},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a15","coord2D":{"x":-1.1048,"y":-1.0509},"charge":0,"isotopeId":"O"},{"__type":"Kekule.Atom","id":"a13","coord2D":{"x":-0.4095,"y":-1.9488},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a21","coord2D":{"x":0.0117,"y":-2.1732},"charge":0,"isotopeId":"H"},{"__type":"Kekule.Atom","id":"a1","coord2D":{"x":2.2257,"y":1.2565},"charge":0,"isotopeId":"N"},{"__type":"Kekule.Atom","id":"a9","coord2D":{"x":1.5115,"y":2.4939},"charge":0,"isotopeId":"O"},{"__type":"Kekule.Atom","id":"a10","coord2D":{"x":2.9428,"y":0.0175},"charge":0,"isotopeId":"N"},{"__type":"Kekule.Atom","id":"a16","coord2D":{"x":-2.2272,"y":-1.4648},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a12","coord2D":{"x":-1.7972,"y":-1.9488},"charge":0,"isotopeId":"C"},{"__type":"Kekule.Atom","id":"a19","coord2D":{"x":-0.4095,"y":-1.5231},"charge":0,"isotopeId":"H"},{"__type__":"Kekule.Atom","id":"a17","coord2D":{"x":-0.4095,"y":-2.4939},"charge":0,"isotopeId":"H"},{"__type__":"Kekule.Atom","id":"a22","coord2D":{"x":-2.2272,"y":-0.8031},"charge":0,"isotopeId":"C"},{"__type__":"Kekule.Atom","id":"a23","coord2D":{"x":-2.2272,"y":-2.1732},"charge":0,"isotopeId":"H"},{"__type__":"Kekule.Atom","id":"a18","coord2D":{"x":-1.7972,"y":-2.4939},"charge":0,"isotopeId":"O"},{"__type__":"Kekule.Atom","id":"a20","coord2D":{"x":-1.7972,"y":-1.5231},"charge":0,"isotopeId":"H"},{"__type__":"Kekule.Atom","id":"a24","coord2D":{"x":-2.9428,"y":-0.3892},"charge":0,"isotopeId":"O"}],"connectors":[{"__type":"Kekule.Bond","connectedNodes":},{"__type":"Kekule.Bond","connectedNodes":},{"__type":"Kekule.Bond","connectedNodes":},{"__type":"Kekule.Bond","connectedNodes":},{"__type":"Kekule.Bond","connectedNodes":},{"__type":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":},{"__type__":"Kekule.Bond","connectedNodes":}]},"name":"Molecule","__type":"Kekule.Molecule"}
	</script>
	
	<script>
	var composer, viewer, btnGen, domBtnTerminate;	
	var calculator, timeStart, timeEnd;
	
	function report(msg) { document.getElementById('state').innerHTML = msg; }
	function getCurrMol() { return Kekule.ChemStructureUtils.getTotalStructFragment(composer.getChemObj()); }
	
	function generate3D() {
		var mol = getCurrMol();
		report('Calculating 3D optimization...');
		btnGen.setEnabled(false);
		domBtnTerminate.disabled = false;
		timeStart = Date.now();
		calculator = Kekule.Calculator.generate3D(mol, {'forceField': ''},
			function(generatedMol){
				btnGen.setEnabled(true);
				domBtnTerminate.disabled = true;
				timeEnd = Date.now();
				viewer.setChemObj(generatedMol);
				report('Ready (' + (timeEnd - timeStart)/1000 + 's)');
			},
			function(err) {
				btnGen.setEnabled(true);
				domBtnTerminate.disabled = true;
				report('Ready - Last error: Calculation failed');
			}
		);
	}

	function terminate() {
		report('User Terminated');
		btnGen.setEnabled(true);
		domBtnTerminate.disabled = true;
		if (calculator) calculator.halt();
	}

	function syncSizes() {
		if (composer) composer.notifyObjectSizeChanged();
		if (viewer) viewer.notifyObjectSizeChanged();
	}
	
	function init() {
		viewer = Kekule.Widget.getWidgetById('chemViewer');
		composer = Kekule.Widget.getWidgetById('composer');
		domBtnTerminate = document.getElementById('ext-btn-terminate');
		
		var toolButtons = composer.getCommonToolButtons() || composer.getDefaultCommonToolBarButtons();
		toolButtons.push({ 'id': 'btnGen', 'text': 'Generate 3D', 'showText': true, 'cssText': 'width:auto', '#execute': generate3D });
		composer.setCommonToolButtons(toolButtons);
		
		btnGen = Kekule.Widget.getWidgetById('btnGen');
		
		// リサイザの実装
		const resizer = document.getElementById('resizer');
		const leftSide = document.getElementById('section-left');
		let isResizing = false;

		resizer.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'col-resize'; });
		window.addEventListener('mousemove', (e) => {
			if (!isResizing) return;
			const newWidth = (e.clientX / window.innerWidth) * 100;
			if (newWidth > 20 && newWidth < 80) {
				leftSide.style.flex = `0 0 ${newWidth}%`;
				syncSizes();
			}
		});
		window.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = 'default'; });

		window.addEventListener('resize', syncSizes);
		setTimeout(syncSizes, 300);
	}
	
	Kekule.X.domReady(init);
	</script>
</head>

<body>
	<header>
		<div class="header-left">
			<div class="logo">3D Molecular Studio Pro</div>
			<div id="state">Ready</div>
		</div>
		<div class="header-right">
			<button id="ext-btn-terminate" onclick="terminate()" disabled>停止 (Terminate)</button>
		</div>
	</header>

	<div class="app-container">
		<div id="section-left" class="tool-section">
			<div id="composer" data-widget="Kekule.Editor.Composer" data-chem-obj="url(#molSrc)" data-predefined-setting="molOnly"></div>
		</div>
		
		<div id="resizer"></div>
		
		<div id="section-right" class="tool-section">
			<div id="chemViewer" data-widget="Kekule.ChemWidget.Viewer3D" data-predefined-setting="fullFunc" 
				data-toolbar-evoke-modes="" data-toolbar-pos="1"></div>
		</div>
	</div>

	<footer>
		2Dで描画し「Generate 3D」をクリックしてください。2026 Edition Pro.
	</footer>
</body>
</html>
